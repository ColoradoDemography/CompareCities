<!DOCTYPE html>
<meta charset="utf-8">
<style>


  body{
    background-color: white;
  }

.node text {
  pointer-events: none;
  font: 10px sans-serif;
  fill: black;
  text-rendering: geometricPrecision;
  stroke-width: 1px;
}
  
  .dt{
    color: black;
    text-align:center;  
    font-style: italic;
    font-size: 14px;
    font-family: "Courier";
    vertical-align: bottom;
  }
  
  span {
    color: #1ABC9C;
    text-align:center;  
    font-style: italic;
    font-size: 14px;
    font-family: "Courier";
    vertical-align: bottom;
}
  
  #similar{

    background-color: white;
    overflow: hidden;
    color: #1ABC9C;
    font-style: italic;
    font-size: 14px;
    font-family: "Courier";
    border: 1px solid grey;
    height: 20px;
    width: 95%;
    transition:             height 500ms ease;
        -moz-transition:    height 500ms ease;
        -ms-transition:     height 500ms ease;
        -o-transition:      height 500ms ease;
        -webkit-transition: height 500ms ease;
}

  
  #table1{
    margin: 15px;
    text-align:center;  
  }
  
input[type="range"]{
    background: rgb(94, 30, 30);
    width: 130px;
    height: 6px;
    -webkit-appearance: none;
    border-radius: 8px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    -webkit-box-shadow: inset 0px 0px 1px 1px rgba(0, 0, 0, 0.9), 0px 1px 1px 0px rgba(255, 255, 255, 0.13);
    -moz-box-shadow: inset 0px 0px 1px 1px rgba(0, 0, 0, 0.9), 0px 1px 1px 0px rgba(255, 255, 255, 0.13);
    box-shadow: inset 0px 0px 1px 1px rgba(0, 0, 0, 0.9), 0px 1px 1px 0px rgba(255, 255, 255, 0.13);
}

input[type="range"]:hover{
    background: rgb(194, 139, 131);
    width: 130px;
    height: 6px;
    -webkit-appearance: none;
    border-radius: 8px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    -webkit-box-shadow: inset 0px 0px 1px 1px rgba(0, 0, 0, 0.9), 0px 1px 1px 0px rgba(255, 255, 255, 0.13);
    -moz-box-shadow: inset 0px 0px 1px 1px rgba(0, 0, 0, 0.9), 0px 1px 1px 0px rgba(255, 255, 255, 0.13);
    box-shadow: inset 0px 0px 1px 1px rgba(0, 0, 0, 0.9), 0px 1px 1px 0px rgba(255, 255, 255, 0.13);
}

input[type="range"]::-webkit-slider-thumb{
   -webkit-appearance:none !important;  
   width:25px;
   height:15px;
   -webkit-appearance: none;
    border-radius: 8px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    border:1px solid black;

    background: #a90329;
    background: -moz-linear-gradient(left, #a90329 0%, #8f0222 50%, #6d0019 100%);
    background: -webkit-gradient(linear, left top, right top, color-stop(0%,#a90329), color-stop(50%,#8f0222), color-stop(100%,#6d0019));
    background: -webkit-linear-gradient(left, #a90329 0%,#8f0222 50%,#6d0019 100%);
    background: -o-linear-gradient(left, #a90329 0%,#8f0222 50%,#6d0019 100%);
    background: -ms-linear-gradient(left, #a90329 0%,#8f0222 50%,#6d0019 100%);
    background: linear-gradient(to right, #a90329 0%,#8f0222 50%,#6d0019 100%);
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#a90329', endColorstr='#6d0019',GradientType=1 );
 }

input[type="range"]::-webkit-slider-thumb:hover{
   -webkit-appearance:none !important;  
   width:25px;
   height:15px;
   -webkit-appearance: none;
    border-radius: 8px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    background-color:rgb(56, 13, 13);
    border:1px solid black;

    background: -moz-linear-gradient(left, #1d2e38 0%, #2b4254 50%, #2b4254 100%);
    background: -webkit-gradient(linear, left top, right top, color-stop(0%,#1d2e38), color-stop(50%,#2b4254), color-stop(100%,#2b4254));
    background: -webkit-linear-gradient(left, #1d2e38 0%,#2b4254 50%,#2b4254 100%);
    background: -o-linear-gradient(left, #1d2e38 0%,#2b4254 50%,#2b4254 100%);
    background: -ms-linear-gradient(left, #1d2e38 0%,#2b4254 50%,#2b4254 100%);
    background: linear-gradient(left, #1d2e38 0%,#2b4254 50%,#2b4254 100%);
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#1d2e38', endColorstr='#2b4254',GradientType=1 );
 }
  
  #controlbox{
    display: block;
    top: 5px;
    left: 10px;
    width: 250px;
    height: 90px;
    border-style: none;
    border-right: 1px solid grey;
  }  
  
  #rangesliders{
    display: block;
    position: absolute;
    top: 5px;
    left: 280px;
    width: 280px;
  }
  #rangesliders2{
    position: absolute;
    display: block;    
    position: absolute;
    top: 5px;
    left: 560px;
    width: 300px;
  }
    #rangesliders3{
    position: absolute;  
    display: block;      
    position: absolute;
    top: 5px;
    left: 865px;
    width: 320px;
  }


  #default{
   height: 20px; 
  }

    #clear{
   height: 20px; 
      margin-top: 5px;
  }
 
      #cityselect{
      margin-top: 5px;
  }
  
  #toptag{
    cursor: default;
    margin-top: 3px;
  }
  
  
  table{
border-collapse:collapse;
border:1px solid grey;
}

table td{
border:1px solid grey;
  padding-right: 10px;
  padding-left: 10px;
}
  
</style>
<body>
  <div id="controlbox"><form>
  <input type="button" id="default" value="Default" onclick="changeval(this);" />
  <input type="button" id="clear" value="Clear" onclick="changeval(this);" />
    <select id="cityselect" onchange="highlightoption(this.value);">
      <option selected>Overview</option>
    </select>
    </form></div>
  
  <div id="rangesliders"><form>
  <span>Population&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="pop" value = 5 min="0" max="10" onchange="show_value(this.value,'slider_value1'); changeval(this)"><span id="slider_value1" style="color:red;"></span><br />   
  <span>Age&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="age" value = 3 min="0" max="10" onchange="show_value(this.value,'slider_value2'); changeval(this)"><span id="slider_value2" style="color:red;"></span><br />  
  <span>Race/Ethnicity&nbsp;</span><input type="range" id="race" value = 3 min="0" max="10" onchange="show_value(this.value,'slider_value3'); changeval(this)"><span id="slider_value3" style="color:red;"></span><br />
  <span>Families&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="fam" value = 2 min="0" max="10" onchange="show_value(this.value,'slider_value4'); changeval(this)"><span id="slider_value4" style="color:red;"></span><br /> 
  <span>Labor Force&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="labor" value = 2 min="0" max="10" onchange="show_value(this.value,'slider_value5'); changeval(this)"><span id="slider_value5" style="color:red;"></span><br />      
    </form></div>

   <div id="rangesliders2"><form> 
  <span>Home Ownership&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="own" value = 2 min="0" max="10" onchange="show_value(this.value,'slider_value6'); changeval(this)"><span id="slider_value6" style="color:red;"></span><br />  
  <span>Household Income&nbsp;&nbsp;</span><input type="range" id="hhi" value = 3 min="0" max="10" onchange="show_value(this.value,'slider_value7'); changeval(this)"><span id="slider_value7" style="color:red;"></span><br />
  <span>Home Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="val" value = 3 min="0" max="10" onchange="show_value(this.value,'slider_value8'); changeval(this)"><span id="slider_value8" style="color:red;"></span><br /> 
  <span>Cost of Rent&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="rent" value = 1 min="0" max="10" onchange="show_value(this.value,'slider_value9'); changeval(this)"><span id="slider_value9" style="color:red;"></span><br />  
  <span>Housing Stock Age&nbsp;</span><input type="range" id="built" value = 1 min="0" max="10" onchange="show_value(this.value,'slider_value10'); changeval(this)"><span id="slider_value10" style="color:red;"></span><br />     
    </form></div>  
  
   <div id="rangesliders3"><form>   
  <span>Education Level&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="edu" value = 3 min="0" max="10" onchange="show_value(this.value,'slider_value11'); changeval(this)"><span id="slider_value11" style="color:red;"></span><br />
  <span>Enrolled in College&nbsp;</span><input type="range" id="enr" value = 2 min="0" max="10" onchange="show_value(this.value,'slider_value12'); changeval(this)"><span id="slider_value12" style="color:red;"></span><br />     
  <span>Drive to Work&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="drive" value = 1 min="0" max="10" onchange="show_value(this.value,'slider_value13'); changeval(this)"><span id="slider_value13" style="color:red;"></span><br />
  <span>Mobility&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="nomove" value = 1 min="0" max="10" onchange="show_value(this.value,'slider_value14'); changeval(this)"><span id="slider_value14" style="color:red;"></span><br />
  <span>Nativity&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type="range" id="native" value = 1 min="0" max="10" onchange="show_value(this.value,'slider_value15'); changeval(this)"><span id="slider_value15" style="color:red;"></span><br />     
    </form></div>  
 <hr /> 
  
  
  <div id="similar">
    <div>
      <p id="toptag"><b>&nbsp;&nbsp;Comparables&nbsp;&nbsp;(Click to Toggle)</b></p>
      <table id="table1">
        <tr><th>Place</th><th>Similarity Score</th><th colspan="3"><span class="dt">Most Alike (of selected) Characteristics:</span> Z-Score</th></tr>
        <tr><td id="comp1"></td><td id="dist1"></td><td id="sim1a"></td><td id="sim2a"></td><td id="sim3a"></td></tr>
        <tr><td id="comp2"></td><td id="dist2"></td><td id="sim1b"></td><td id="sim2b"></td><td id="sim3b"></td></tr>
        <tr><td id="comp3"></td><td id="dist3"></td><td id="sim1c"></td><td id="sim2c"></td><td id="sim3c"></td></tr>
        <tr><td id="comp4"></td><td id="dist4"></td><td id="sim1d"></td><td id="sim2d"></td><td id="sim3d"></td></tr>
        <tr><td id="comp5"></td><td id="dist5"></td><td id="sim1e"></td><td id="sim2e"></td><td id="sim3e"></td></tr>
      </table>  
    </div>
  </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-76100845-1', 'auto');
  ga('set', 'anonymizeIp', true);
  ga('send', 'pageview');
</script>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script>
  
  //collapsible div for comparables
  document.getElementById( 'similar' ).addEventListener( 'click', function() {
 
    ( this.style.height == '20px' || this.style.height == '' )
        ? this.style.height = 'auto' 
        : this.style.height = '20px';
    
}, false );
  
  var linksdata; //global all links
  var pop=5, race=3, fam=2, built=1, labor=2, native=1, age=3, edu=3, enr=2, drive=1, nomove=1, own=2, hhi=3, val=3, rent=1; 
  
  function show_value(x,id){
 document.getElementById(id).innerHTML=x;
}
    
  function calcsimilarity(links){
    var linkdistance;
    var currentlyselected=document.getElementById("cityselect").value;
    var resultsarray=[]; //array of objects
    var currentobject={}; //will be pushed into resultsarray
    
    links.forEach(function(d, i) {
      currentobject={};
      if(links[i].source.geoname === currentlyselected){ currentobject.geoname=links[i].target.geoname;}
      if(links[i].target.geoname === currentlyselected){ currentobject.geoname=links[i].source.geoname;}
      if(links[i].source.geoname === currentlyselected || links[i].target.geoname === currentlyselected){
        linkdistance=(pop*d.pop)+(race*d.race)+(fam*d.fam)+(built*d.built)+(labor*d.labor)+(native*d.native)+(age*d.age)+(edu*d.edu)+(enr*d.enr)+(drive*d.drive)+(nomove*d.nomove)+(own*d.own)+(hhi*d.hhi)+(val*d.val)+(rent*d.rent);
        currentobject.linkdistance=linkdistance;
        currentobject.pop=d.pop;
        currentobject.race=d.race;
        currentobject.fam=d.fam;
        currentobject.built=d.built;
        currentobject.labor=d.labor;
        currentobject.native=d.native;
        currentobject.age=d.age;
        currentobject.edu=d.edu;
        currentobject.enr=d.enr;
        currentobject.drive=d.drive;
        currentobject.nomove=d.nomove;
        currentobject.own=d.own;
        currentobject.hhi=d.hhi;
        currentobject.val=d.val;
        currentobject.rent=d.rent;
        resultsarray.push(currentobject);
      }
    });
    
    resultsarray.sort(function(a, b){
      if(a.linkdistance < b.linkdistance) return -1;
      if(a.linkdistance > b.linkdistance) return 1;
      return 0;
    });
    
    var top5attributes = resultsarray.map(function(d,i) {
      
  return {
    "Total Population":d.pop,
    "Race":d.race,
    "Family":d.fam,
    "Housing Stock":d.built,
    "Labor Force":d.labor,
    "Nativity":d.native,
    "Age":d.age,
    "Educational Attainment":d.edu,
    "Enrolled in College":d.enr,
    "Drive to Work":d.drive,
    "Mobility":d.nomove,
    "Home Ownership":d.own,
    "Household Income":d.hhi,
    "Home Value":d.val,
    "Cost to Rent":d.rent
  };
});
    
    var master=[]; //final master array of sorted alike variables for top 5 comparables
    var toarray=[], sortable=[], item, j;
    
    for(j=0;j<5;j=j+1){
    toarray = top5attributes[j];
    sortable = [];
    
    for (item in toarray){
      sortable.push([item, toarray[item]]);      
    }
    
     sortable.sort(function(a, b) {return a[1] - b[1]});
    
    master.push(sortable);
    }

    console.log(master);
    
    document.getElementById('comp1').innerHTML = resultsarray[0].geoname+'&nbsp;&nbsp;';
    document.getElementById('comp2').innerHTML = resultsarray[1].geoname+'&nbsp;&nbsp;'; 
    document.getElementById('comp3').innerHTML = resultsarray[2].geoname+'&nbsp;&nbsp;';  
    document.getElementById('comp4').innerHTML = resultsarray[3].geoname+'&nbsp;&nbsp;';
    document.getElementById('comp5').innerHTML = resultsarray[4].geoname+'&nbsp;&nbsp;';
        
    document.getElementById('dist1').innerHTML = (resultsarray[0].linkdistance).toFixed(2);
    document.getElementById('dist2').innerHTML = (resultsarray[1].linkdistance).toFixed(2); 
    document.getElementById('dist3').innerHTML = (resultsarray[2].linkdistance).toFixed(2);  
    document.getElementById('dist4').innerHTML = (resultsarray[3].linkdistance).toFixed(2);
    document.getElementById('dist5').innerHTML = (resultsarray[4].linkdistance).toFixed(2);
    
    document.getElementById('sim1a').innerHTML = '<span class="dt">'+master[0][0][0]+':</span>'+master[0][0][1];
    document.getElementById('sim1b').innerHTML = '<span class="dt">'+master[1][0][0]+':</span>'+master[1][0][1];
    document.getElementById('sim1c').innerHTML = '<span class="dt">'+master[2][0][0]+':</span>'+master[2][0][1];
    document.getElementById('sim1d').innerHTML = '<span class="dt">'+master[3][0][0]+':</span>'+master[3][0][1];
    document.getElementById('sim1e').innerHTML = '<span class="dt">'+master[4][0][0]+':</span>'+master[4][0][1];
    
    document.getElementById('sim2a').innerHTML = '<span class="dt">'+master[0][1][0]+':</span>'+master[0][1][1];
    document.getElementById('sim2b').innerHTML = '<span class="dt">'+master[1][1][0]+':</span>'+master[1][1][1];
    document.getElementById('sim2c').innerHTML = '<span class="dt">'+master[2][1][0]+':</span>'+master[2][1][1];
    document.getElementById('sim2d').innerHTML = '<span class="dt">'+master[3][1][0]+':</span>'+master[3][1][1];
    document.getElementById('sim2e').innerHTML = '<span class="dt">'+master[4][1][0]+':</span>'+master[4][1][1];
    
    document.getElementById('sim3a').innerHTML = '<span class="dt">'+master[0][2][0]+':</span>'+master[0][2][1];
    document.getElementById('sim3b').innerHTML = '<span class="dt">'+master[1][2][0]+':</span>'+master[1][2][1];
    document.getElementById('sim3c').innerHTML = '<span class="dt">'+master[2][2][0]+':</span>'+master[2][2][1];
    document.getElementById('sim3d').innerHTML = '<span class="dt">'+master[3][2][0]+':</span>'+master[3][2][1];
    document.getElementById('sim3e').innerHTML = '<span class="dt">'+master[4][2][0]+':</span>'+master[4][2][1];
  }
  
  function highlightoption(highlighted){

    var i;
    var circles = svg.selectAll("circle");
    var targetcircle;
    
    d3.selectAll("circle").each( function(d, i){
      if(d.geoname == highlighted){
        
        var cur
       
        d3.select(this).attr("stroke-width", 3)
        .attr("r", function(d){return (Math.pow((Number(d.pop)/1000),1/2))+2;})
        .attr("stroke", "yellow");
        }else{
        d3.select(this).attr("stroke-width", null)
        .attr("r", function(d){return Math.pow((Number(d.pop)/1000),1/2);})
        .attr("stroke", null);
        }
      
    });
    
    force.linkStrength(function(link) {
     // console.log(link);
        if (link.source.geoname === highlighted || link.target.geoname === highlighted){ return 2; }else{ return 0.1};
    }).start();
    
    calcsimilarity(linksdata);
  }
  

  
  function changeval(slider){
    
    //slider change
    if(slider.id==='pop'){pop=Number(slider.value);}
    if(slider.id==='race'){race=Number(slider.value);}
    if(slider.id==='fam'){fam=Number(slider.value);}
    if(slider.id==='built'){built=Number(slider.value);}
    if(slider.id==='labor'){labor=Number(slider.value);}
    if(slider.id==='native'){native=Number(slider.value);} 
    if(slider.id==='age'){age=Number(slider.value);}
    if(slider.id==='edu'){edu=Number(slider.value);}
    if(slider.id==='enr'){enr=Number(slider.value);}
    if(slider.id==='drive'){drive=Number(slider.value);}
    if(slider.id==='nomove'){nomove=Number(slider.value);}
    if(slider.id==='own'){own=Number(slider.value);}  
    if(slider.id==='hhi'){hhi=Number(slider.value);}
    if(slider.id==='val'){val=Number(slider.value);}
    if(slider.id==='rent'){rent=Number(slider.value);}

    
    //default button
    if(slider.id==='default'){
      show_value(5,'slider_value1'); show_value(3,'slider_value2'); show_value(3,'slider_value3'); show_value(2,'slider_value4'); show_value(2,'slider_value5');
      show_value(2,'slider_value6'); show_value(3,'slider_value7'); show_value(3,'slider_value8'); show_value(1,'slider_value9'); show_value(1,'slider_value10');
      show_value(3,'slider_value11'); show_value(2,'slider_value12'); show_value(1,'slider_value13'); show_value(1,'slider_value14'); show_value(1,'slider_value15');      
      pop=5; race=3; fam=2; built=1; labor=2; native=1; age=3; edu=3; enr=2; drive=1; nomove=1; own=2; hhi=3; val=3; rent=1;
      document.getElementById("pop").value = 5; document.getElementById("age").value = 3; document.getElementById("race").value = 3;
      document.getElementById("fam").value = 2; document.getElementById("labor").value = 2; document.getElementById("own").value = 2;
      document.getElementById("hhi").value = 3; document.getElementById("val").value = 3; document.getElementById("rent").value = 1;
      document.getElementById("built").value = 1; document.getElementById("edu").value = 3; document.getElementById("enr").value = 2;
      document.getElementById("drive").value = 1; document.getElementById("nomove").value = 1; document.getElementById("native").value = 1;
    }
    
    //clear button
    if(slider.id==='clear'){
      show_value(0,'slider_value1'); show_value(0,'slider_value2'); show_value(0,'slider_value3'); show_value(0,'slider_value4'); show_value(0,'slider_value5');
      show_value(0,'slider_value6'); show_value(0,'slider_value7'); show_value(0,'slider_value8'); show_value(0,'slider_value9'); show_value(0,'slider_value10');
      show_value(0,'slider_value11'); show_value(0,'slider_value12'); show_value(0,'slider_value13'); show_value(0,'slider_value14'); show_value(0,'slider_value15');        
      pop=0; race=0; fam=0; built=0; labor=0; native=0; age=0; edu=0; enr=0; drive=0; nomove=0; own=0; hhi=0; val=0; rent=0;
      document.getElementById("pop").value = 0; document.getElementById("age").value = 0; document.getElementById("race").value = 0;
      document.getElementById("fam").value = 0; document.getElementById("labor").value = 0; document.getElementById("own").value = 0;
      document.getElementById("hhi").value = 0; document.getElementById("val").value = 0; document.getElementById("rent").value = 0;
      document.getElementById("built").value = 0; document.getElementById("edu").value = 0; document.getElementById("enr").value = 0;
      document.getElementById("drive").value = 0; document.getElementById("nomove").value = 0; document.getElementById("native").value = 0;
    }
    
    var total;
    total = 1+pop+race+fam+built+labor+native+age+edu+enr+drive+nomove+own+hhi+val+rent;
    var multiplier;
    multiplier=231/total;

    //redraw force layout with new weights
      force
	    .linkDistance(function(d) { return  1+((d.pop*pop)+(d.race*race)+(d.fam*fam)+(d.built*built)+(d.labor*labor)+(d.native*native)+(d.age*age)+(d.edu*edu)+(d.enr*enr)+(d.drive*drive)+(d.nomove*nomove)+(d.own*own)+(d.hhi*hhi)+(d.val*val)+(d.rent*rent))*multiplier; }) 
      .start();
    
        calcsimilarity(linksdata);
    
  }
  
  //initial slider label values
  show_value(5,'slider_value1'); show_value(3,'slider_value2'); show_value(3,'slider_value3'); show_value(2,'slider_value4'); show_value(2,'slider_value5');
  show_value(2,'slider_value6'); show_value(3,'slider_value7'); show_value(3,'slider_value8'); show_value(1,'slider_value9'); show_value(1,'slider_value10');
  show_value(3,'slider_value11'); show_value(2,'slider_value12'); show_value(1,'slider_value13'); show_value(1,'slider_value14'); show_value(1,'slider_value15');  
  

var width = 1200,
    height = 600;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-30)
	  .gravity(0.1)
	  .linkDistance(function(d) { return  1+((d.pop*pop)+(d.race*race)+(d.fam*fam)+(d.built*built)+(d.labor*labor)+(d.native*native)+Math.sqrt(d.age*age)+(d.edu*edu)+(d.enr*enr)+(d.drive*drive)+(d.nomove*nomove)+(d.own*own)+(d.hhi*hhi)+(d.val*val)+(d.rent*rent))*(231/(1+pop+race+fam+built+labor+native+age+edu+enr+drive+nomove+own+hhi+val+rent)); }) 
	  .linkStrength(1) 
    .friction(0.9)
    .size([width, height]);
	

  
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

d3.json("data/recocities5k.json", function(error, graph) {
  
  linksdata=graph.links;  //make this available globally

  
  //fill in selectbox with placenames
    (function loadselect(){
      
      var i;
      var selectelem=document.getElementById("cityselect");
      
    for(i=0;i<graph.nodes.length;i=i+1){
    var opt = document.createElement('option');
    opt.value = graph.nodes[i].geoname;
    opt.innerHTML = graph.nodes[i].geoname.replace(" city","").replace(" town","").replace(" CDP","").replace(", Colorado","");
    selectelem.appendChild(opt);
    }
    
    })(); //invoke
   

  
  force.nodes(graph.nodes)
      .links(graph.links)
      .start();


  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
    .attr("class", "node")
    .call(force.drag);
  
node.append("circle")
      .attr("r", function(d){return Math.pow((Number(d.pop)/1000),1/2)})
      .style("fill", function(d) { 
if(d.reg==="fr"){return "rgb(127,201,127)";}
if(d.reg==="ws"){return "rgb(191,91,23)";}
if(d.reg==="cm"){return "rgb(190,174,212)";}
if(d.reg==="slv"){return "rgb(56,108,176)";}  
if(d.reg==="ep"){return "rgb(253,192,134)";}  
});

 
  
  node.append("title")
      .text(function(d) { return d.geoname; });

node.append("text")
      .attr("dx", 10)
      .attr("dy", ".35em")
      .text(function(d) { if(d.pop>50000){return (d.geoname).replace(" city","").replace(" town","").replace(" CDP","").replace(", Colorado","");}else{return " ";}});

  
  force.on("tick", function() {
    
    //keep in bounding box
    node.attr("cx", function(d) { return d.x = Math.max(25, Math.min(width - 25, d.x)); })
           .attr("cy", function(d) { return d.y = Math.max(25, Math.min(height - 25, d.y)); });
    
        d3.selectAll("circle").attr("cx", function (d) {
        return d.x;
    })
        .attr("cy", function (d) {
        return d.y;
    });

    d3.selectAll("text").attr("x", function (d) {
        return d.x;
    })
        .attr("y", function (d) {
        return d.y;
    });

  });
  
 
    document.getElementById( 'cityselect' ).onchange(); 
  
});

</script>
